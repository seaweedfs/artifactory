name: "EC Integration Tests (GitLab)"

on:
  # Triggered by GitLab webhook
  repository_dispatch:
    types: 
      - gitlab-push
      - gitlab-merge-request
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      gitlab_branch:
        description: 'GitLab branch to test'
        required: false
        default: 'enterprise'

concurrency:
  group: ${{ github.head_ref || github.run_id }}/ec-integration
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  ec-integration-tests:
    name: EC Integration Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    steps:
    - name: Checkout artifactory repo
      uses: actions/checkout@v5

    - name: Clone private GitLab repository
      env:
        GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      run: |
        # Determine branch from webhook or manual input
        if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
          BRANCH_REF="${{ github.event.client_payload.ref || 'refs/heads/enterprise' }}"
          BRANCH=$(echo "$BRANCH_REF" | sed 's|refs/heads/||')
        else
          BRANCH="${{ github.event.inputs.gitlab_branch || 'enterprise' }}"
        fi
        
        echo "Cloning branch: $BRANCH"
        git clone -b $BRANCH https://gitlab-ci-token:${GITLAB_TOKEN}@gitlab.com/chrislusf/seaweedfs.git seaweedfs-source
        
        cd seaweedfs-source
        echo "Cloned commit: $(git rev-parse HEAD)"
        echo "COMMIT_SHA=$(git rev-parse --short=8 HEAD)" >> $GITHUB_ENV
        echo "BRANCH_NAME=$BRANCH" >> $GITHUB_ENV

    - name: Set up Go 1.x
      uses: actions/setup-go@v6
      with:
        go-version-file: 'seaweedfs-source/go.mod'
        cache-dependency-path: 'seaweedfs-source/go.sum'
      id: go

    - name: Build weed binary
      working-directory: seaweedfs-source/weed
      run: |
        echo "Building SeaweedFS weed binary for EC tests..."
        go build -o weed .
        
        # Verify binary
        echo "Verifying built binary..."
        ./weed version
        ls -lh weed
        
        # Make binary available in PATH for tests
        echo "$(pwd)" >> $GITHUB_PATH

    - name: Run EC Integration Tests
      working-directory: seaweedfs-source/test/erasure_coding
      run: |
        echo "Running EC Integration Tests..."
        echo "Test directory contents:"
        ls -la
        
        # Run the integration tests with verbose output
        go test -v -timeout 30m

    - name: Run EC Disk-Aware Tests
      if: success() || failure()
      working-directory: seaweedfs-source/test/erasure_coding
      run: |
        echo "Running EC Disk-Aware Rebalancing Tests..."
        go test -v -run TestDiskAwareECRebalancing -timeout 30m || true

    - name: Run EC Disk Type Tests
      if: success() || failure()
      working-directory: seaweedfs-source/test/erasure_coding
      run: |
        echo "Running EC Disk Type Support Tests..."
        go test -v -run TestECDiskTypeSupport -timeout 30m || true

    - name: Run EC Cross-Rack Placement Tests
      if: success() || failure()
      working-directory: seaweedfs-source/test/erasure_coding
      run: |
        echo "Running EC Cross-Rack Placement Tests..."
        go test -v -run TestCrossRackECPlacement -timeout 30m || true

    - name: Archive test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ec-integration-test-logs-${{ env.COMMIT_SHA }}
        path: |
          seaweedfs-source/test/erasure_coding/*.log
          /tmp/seaweedfs_ec_*/*.log
        if-no-files-found: ignore
        retention-days: 7

    - name: EC Integration Test Summary
      if: always()
      run: |
        echo "## ðŸ”§ EC Integration Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### GitLab Source" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: https://gitlab.com/chrislusf/seaweedfs" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ env.COMMIT_SHA }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ env.BRANCH_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Tests Executed" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ§ª **EC Encoding/Decoding**: Volume location timing bug fix verification" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”„ **Master Timing Race Condition**: Race condition simulation and fix verification" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š **Shard Distribution**: Multi-server EC shard distribution tests" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ§¹ **Cleanup Verification**: Post-encoding cleanup validation" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ’¿ **Disk-Aware EC Rebalancing**: Multi-disk shard placement tests" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ **Disk Type Support**: SSD/HDD disk type filtering tests" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ¢ **Cross-Rack Placement**: Rack-aware EC shard distribution" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Features Covered" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **EC 10+4 Encoding**: Standard erasure coding with 10 data + 4 parity shards" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Customizable EC Ratios**: Enterprise feature for custom data/parity ratios" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Volume Location Collection**: Pre-encoding location caching" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Multi-Disk Support**: Distribution across multiple disks per server" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Disk Type Filtering**: SSD/HDD-aware EC placement" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Rack-Aware Placement**: Cross-rack fault tolerance" >> $GITHUB_STEP_SUMMARY

  # Additional job for custom EC ratio tests (Enterprise feature)
  ec-custom-ratio-tests:
    name: EC Custom Ratio Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    steps:
    - name: Checkout artifactory repo
      uses: actions/checkout@v5

    - name: Clone private GitLab repository
      env:
        GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      run: |
        # Determine branch from webhook or manual input
        if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
          BRANCH_REF="${{ github.event.client_payload.ref || 'refs/heads/enterprise' }}"
          BRANCH=$(echo "$BRANCH_REF" | sed 's|refs/heads/||')
        else
          BRANCH="${{ github.event.inputs.gitlab_branch || 'enterprise' }}"
        fi
        
        echo "Cloning branch: $BRANCH"
        git clone -b $BRANCH https://gitlab-ci-token:${GITLAB_TOKEN}@gitlab.com/chrislusf/seaweedfs.git seaweedfs-source
        
        cd seaweedfs-source
        echo "Cloned commit: $(git rev-parse HEAD)"
        echo "COMMIT_SHA=$(git rev-parse --short=8 HEAD)" >> $GITHUB_ENV

    - name: Set up Go 1.x
      uses: actions/setup-go@v6
      with:
        go-version-file: 'seaweedfs-source/go.mod'
        cache-dependency-path: 'seaweedfs-source/go.sum'
      id: go

    - name: Build weed binary
      working-directory: seaweedfs-source/weed
      run: |
        echo "Building SeaweedFS weed binary..."
        go build -o weed .
        ./weed version
        echo "$(pwd)" >> $GITHUB_PATH

    - name: Test Custom EC Ratios
      working-directory: seaweedfs-source
      run: |
        echo "Testing Custom EC Ratio Support (Enterprise Feature)..."
        
        # Check if custom EC ratio implementation exists
        if grep -r "CustomECRatio\|ecRatio\|ErasureCodingRatio" weed/shell/ 2>/dev/null; then
          echo "Custom EC ratio implementation found!"
          
          # Run any custom EC ratio tests
          if [ -d "test/erasure_coding_custom" ]; then
            cd test/erasure_coding_custom
            go test -v -timeout 30m
          else
            echo "No custom EC ratio test directory found, running standard EC tests with ratio flags..."
          fi
        else
          echo "Custom EC ratio feature not yet implemented in this branch"
        fi

    - name: Test EC Shell Commands
      working-directory: seaweedfs-source
      run: |
        echo "Verifying EC shell command flags..."
        
        # Check ec.encode help for custom ratio flags
        ./weed/weed shell -c "help ec.encode" 2>&1 || echo "Shell help check skipped"
        
        # Verify the EC commands exist and have expected flags
        echo "Checking EC command implementations..."
        
        if grep -q "ecRatio\|dataShards\|parityShards" weed/shell/command_ec_encode.go 2>/dev/null; then
          echo "âœ… Custom EC ratio flags found in ec.encode command"
        else
          echo "â„¹ï¸ Using standard 10+4 EC ratio"
        fi

    - name: EC Custom Ratio Test Summary
      if: always()
      run: |
        echo "## ðŸ”¢ EC Custom Ratio Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Enterprise EC Features" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š **Custom Data Shards**: Configurable number of data shards (default: 10)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ›¡ï¸ **Custom Parity Shards**: Configurable number of parity shards (default: 4)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”§ **Flexible Ratios**: Support for various EC configurations (e.g., 4+2, 6+3, 10+4, 16+4)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Use Cases" >> $GITHUB_STEP_SUMMARY
        echo "- **High Durability**: 10+4 provides ~1.4x storage overhead with high fault tolerance" >> $GITHUB_STEP_SUMMARY
        echo "- **Storage Efficient**: 4+2 provides ~1.5x overhead with good fault tolerance" >> $GITHUB_STEP_SUMMARY
        echo "- **Max Efficiency**: 16+4 provides ~1.25x overhead for large-scale storage" >> $GITHUB_STEP_SUMMARY

  # Regression test job
  ec-regression-tests:
    name: EC Regression Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    steps:
    - name: Checkout artifactory repo
      uses: actions/checkout@v5

    - name: Clone private GitLab repository
      env:
        GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      run: |
        if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
          BRANCH_REF="${{ github.event.client_payload.ref || 'refs/heads/enterprise' }}"
          BRANCH=$(echo "$BRANCH_REF" | sed 's|refs/heads/||')
        else
          BRANCH="${{ github.event.inputs.gitlab_branch || 'enterprise' }}"
        fi
        
        echo "Cloning branch: $BRANCH"
        git clone -b $BRANCH https://gitlab-ci-token:${GITLAB_TOKEN}@gitlab.com/chrislusf/seaweedfs.git seaweedfs-source
        
        cd seaweedfs-source
        echo "COMMIT_SHA=$(git rev-parse --short=8 HEAD)" >> $GITHUB_ENV

    - name: Set up Go 1.x
      uses: actions/setup-go@v6
      with:
        go-version-file: 'seaweedfs-source/go.mod'
        cache-dependency-path: 'seaweedfs-source/go.sum'
      id: go

    - name: Run EC Regression Tests
      working-directory: seaweedfs-source/test/erasure_coding
      run: |
        echo "Running EC Regression Prevention Tests..."
        go test -v -run TestECEncodingRegressionPrevention -timeout 10m

    - name: Run EC Unit Tests
      working-directory: seaweedfs-source/weed
      run: |
        echo "Running EC-related unit tests..."
        go test -v ./storage/erasure_coding/... -timeout 10m || true
        go test -v ./shell/... -run ".*[Ee][Cc].*" -timeout 10m || true

    - name: EC Regression Test Summary
      if: always()
      run: |
        echo "## ðŸ”’ EC Regression Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Regression Prevention" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Function Signature Checks**: Verify fixed function signatures haven't reverted" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Timing Pattern Checks**: Verify correct volume location collection order" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Error Handling**: Verify proper error returns (not silent nil)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Known Bug Fixes Verified" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ› **Double Storage Bug**: Volume locations collected BEFORE EC encoding" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ› **Silent Failure Bug**: Functions return proper errors" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ› **Cleanup Race Condition**: Pre-collected locations used for cleanup" >> $GITHUB_STEP_SUMMARY

